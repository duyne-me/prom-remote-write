services:
  # ============================================================================
  # MOCK EXPORTERS - Simulate application metrics
  # ============================================================================
  
  # Python Mock Exporter - Main metrics source
  mock-exporter-python:
    image: ghcr.io/duyne-me/mock-exporter-python:latest
    container_name: mock-exporter-python
    ports:
      - "2112:2112"
    environment:
      - HOST=0.0.0.0
      - PORT=2112
      - LOG_LEVEL=info
    networks:
      - promnet

  # Go Mock Exporter - Alternative exporter
  mock-exporter-golang:
    image: ghcr.io/duyne-me/mock-exporter-golang:latest
    container_name: mock-exporter-golang
    ports:
      - "2113:2112"
    networks:
      - promnet

  # ============================================================================
  # VICTORIAMETRICS CLUSTER - Central time series storage
  # Region: us-east-1 (Centralized single-region architecture)
  # All vmagents from other regions (eu-west-1, ap-southeast-1) remote write
  # cross-region to this cluster. This demonstrates centralized monitoring
  # with cross-region latency implications.
  # ============================================================================
  
  # vmstorage nodes - Persistent storage layer
  vmstorage-1:
    image: victoriametrics/vmstorage:latest
    container_name: vmstorage-1
    command:
      - "--storageDataPath=/vmstorage-data"
      - "--retentionPeriod=1y"
      - "--httpListenAddr=:8482"
    volumes:
      - vmstorage-1-data:/vmstorage-data
    networks:
      - promnet

  vmstorage-2:
    image: victoriametrics/vmstorage:latest
    container_name: vmstorage-2
    command:
      - "--storageDataPath=/vmstorage-data"
      - "--retentionPeriod=1y"
      - "--httpListenAddr=:8482"
    volumes:
      - vmstorage-2-data:/vmstorage-data
    networks:
      - promnet

  # vminsert nodes - Ingestion layer (load balanced)
  vminsert-1:
    image: victoriametrics/vminsert:latest
    container_name: vminsert-1
    command:
      - "--storageNode=vmstorage-1:8400"
      - "--storageNode=vmstorage-2:8400"
      - "--httpListenAddr=:8480"
    depends_on:
      - vmstorage-1
      - vmstorage-2
    networks:
      - promnet

  vminsert-2:
    image: victoriametrics/vminsert:latest
    container_name: vminsert-2
    command:
      - "--storageNode=vmstorage-1:8400"
      - "--storageNode=vmstorage-2:8400"
      - "--httpListenAddr=:8480"
    depends_on:
      - vmstorage-1
      - vmstorage-2
    networks:
      - promnet

  # vmselect nodes - Query layer
  vmselect-1:
    image: victoriametrics/vmselect:latest
    container_name: vmselect-1
    command:
      - "--storageNode=vmstorage-1:8401"
      - "--storageNode=vmstorage-2:8401"
      - "--httpListenAddr=:8481"
    depends_on:
      - vmstorage-1
      - vmstorage-2
    networks:
      - promnet

  vmselect-2:
    image: victoriametrics/vmselect:latest
    container_name: vmselect-2
    command:
      - "--storageNode=vmstorage-1:8401"
      - "--storageNode=vmstorage-2:8401"
      - "--httpListenAddr=:8481"
    depends_on:
      - vmstorage-1
      - vmstorage-2
    networks:
      - promnet

  # ============================================================================
  # VMAGENT INSTANCES - Multi-environment, multi-cluster monitoring agents
  # 
  # FLOW 1 (Main): Application → vmagent (scrape) → vminsert → vmstorage
  #
  # Each vmagent:
  # - Scrapes applications in its cluster (mock-exporter)
  # - Self-scrapes for internal metrics (scrape_duration_seconds, etc.)
  # - Probes blackbox-exporter for cross-region latency
  # - Adds external_labels: env, region, cluster
  # - Remote writes directly to vminsert (no intermediary)
  #
  # Naming convention: {region}-eks-{number}-{env}
  # ============================================================================

  # DEV ENVIRONMENT - Development cluster in Singapore
  # Cluster: ap-southeast-1-eks-01-dev
  # Purpose: Development and testing environment
  vmagent-ap-southeast-1-eks-01-dev:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-ap-southeast-1-eks-01-dev
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-1:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8429:8429"
    volumes:
      - ./vmagent/ap-southeast-1-eks-01-dev.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-1
      - blackbox-exporter
    networks:
      - promnet

  # PROD ENVIRONMENT - Production cluster 1 in US East (HA setup)
  # Cluster: us-east-1-eks-01-prod
  # Purpose: Production workloads, HA pair with eks-02
  vmagent-us-east-1-eks-01-prod:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-us-east-1-eks-01-prod
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-1:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8430:8429"
    volumes:
      - ./vmagent/us-east-1-eks-01-prod.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-1
      - blackbox-exporter
    networks:
      - promnet

  # PROD ENVIRONMENT - Production cluster 2 in US East (HA setup)
  # Cluster: us-east-1-eks-02-prod
  # Purpose: Production workloads, HA pair with eks-01
  vmagent-us-east-1-eks-02-prod:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-us-east-1-eks-02-prod
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-2:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8431:8429"
    volumes:
      - ./vmagent/us-east-1-eks-02-prod.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-2
      - blackbox-exporter
    networks:
      - promnet

  # PROD ENVIRONMENT - Production cluster in EU West
  # Cluster: eu-west-1-eks-01-prod
  # Purpose: Serve European users with low latency
  vmagent-eu-west-1-eks-01-prod:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-eu-west-1-eks-01-prod
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-1:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8432:8429"
    volumes:
      - ./vmagent/eu-west-1-eks-01-prod.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-1
      - blackbox-exporter
    networks:
      - promnet

  # PROD ENVIRONMENT - Production cluster in Singapore
  # Cluster: ap-southeast-1-eks-01-prod
  # Purpose: Serve APAC users with low latency
  vmagent-ap-southeast-1-eks-01-prod:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-ap-southeast-1-eks-01-prod
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-2:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8433:8429"
    volumes:
      - ./vmagent/ap-southeast-1-eks-01-prod.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-2
      - blackbox-exporter
    networks:
      - promnet

  # BETA ENVIRONMENT - Beta cluster in Tokyo
  # Cluster: ap-northeast-1-eks-01-beta
  # Purpose: Beta testing environment for new features
  vmagent-ap-northeast-1-eks-01-beta:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-ap-northeast-1-eks-01-beta
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-1:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8435:8429"
    volumes:
      - ./vmagent/ap-northeast-1-eks-01-beta.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - mock-exporter-python
      - vminsert-1
      - blackbox-exporter
    networks:
      - promnet

  # ============================================================================
  # PROMETHEUS RECEIVER - Accept remote write from external/legacy systems
  #
  # FLOW 2 (Push): External/Legacy → prometheus-receiver → vmagent-receiver-scraper → vminsert
  #
  # Purpose: Allow external Prometheus instances or legacy monitoring systems
  # to push metrics into the VictoriaMetrics cluster
  #
  # How it works:
  # 1. External system remote writes to prometheus-receiver (port 9091)
  # 2. prometheus-receiver accepts and temporarily stores metrics
  # 3. vmagent-receiver-scraper scrapes prometheus-receiver's metrics endpoint
  # 4. vmagent-receiver-scraper forwards to vminsert (same as Flow 1)
  #
  # Note: This is separate from the main vmagent flow (Flow 1)
  # ============================================================================

  # Prometheus Receiver - Remote write endpoint for external/legacy systems
  # Accepts remote write on port 9091
  # Retention: 1h (short, data forwarded by vmagent-receiver-scraper)
  prometheus-receiver:
    image: prom/prometheus:v3.7.0
    container_name: prometheus-receiver
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver"
      - "--storage.tsdb.retention.time=1h"  # Short retention, data forwarded by vmagent
    volumes:
      - ./prometheus/receiver.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9091:9090"
    networks:
      - promnet

  # vmagent Receiver Scraper - Scrapes prometheus-receiver and forwards to VictoriaMetrics
  # Part of Flow 2 (Push flow)
  # Scrapes prometheus-receiver:9091/metrics and remote writes to vminsert
  # Labels: env=prod, region=us-east-1, cluster=us-east-1-eks-01-prod-legacy (legacy system)
  vmagent-receiver-scraper:
    image: victoriametrics/vmagent:latest
    container_name: vmagent-receiver-scraper
    command:
      - "--promscrape.config=/etc/vmagent/config.yml"
      - "--remoteWrite.url=http://vminsert-1:8480/insert/0/prometheus/api/v1/write"
      - "--httpListenAddr=:8429"
    ports:
      - "8434:8429"
    volumes:
      - ./vmagent/receiver-scraper.yml:/etc/vmagent/config.yml:ro
    depends_on:
      - prometheus-receiver
      - vminsert-1
    networks:
      - promnet

  # ============================================================================
  # BLACKBOX EXPORTER - Network probing for cross-region latency monitoring
  #
  # Purpose: Perform HTTP probes to measure network latency
  # Probed by: All 5 vmagents (each vmagent scrapes blackbox-exporter)
  # Metrics generated: probe_duration_seconds, probe_success
  # Use case: Monitor cross-region network connectivity and latency
  # ============================================================================

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    ports:
      - "9115:9115"
    volumes:
      - ./blackbox/config.yml:/etc/blackbox_exporter/config.yml:ro
    command:
      - '--config.file=/etc/blackbox_exporter/config.yml'
    networks:
      - promnet

  # ============================================================================
  # GRAFANA - Visualization and dashboards
  # ============================================================================

  grafana:
    image: grafana/grafana:12.2.0
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_USERS_DEFAULT_THEME=dark
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=critical
    volumes:
      - ./grafana/provisioning/datasources.yml:/etc/grafana/provisioning/datasources/provisioning-datasources.yaml:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus-receiver
      - vmselect-1
    networks:
      - promnet

volumes:
  vmstorage-1-data:
  vmstorage-2-data:

networks:
  promnet:
    driver: bridge
